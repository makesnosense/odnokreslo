---
import MapToggleButton from "./MapToggleButton.astro";
---

<section class="location-section">
  <div class="address">
    <p>Москва, Новый Арбат, 34с1</p>
    <p>ПН–ВС: 13:00–22:00</p>
    <p>По предварительной записи</p>
    <p>Бесплатная парковка на территории</p>
  </div>
  <div class="map-container">
    <div class="map grayscale">
      <a
        href="https://yandex.ru/maps/-/CLbwQ87U"
        target="_blank"
        rel="noopener noreferrer"
        class="yandex-open-maps-btn"
        aria-label="Открыть в Яндекс Картах"
      >
        <svg
          class="btn-icon-mobile"
          xmlns="http://www.w3.org/2000/svg"
          width="24"
          height="24"
          viewBox="0 0 24 24"
          fill="none"
        >
          <path
            d="M12 1a9.002 9.002 0 0 0-6.366 15.362c1.63 1.63 5.466 3.988 5.693 6.465.034.37.303.673.673.673.37 0 .64-.303.673-.673.227-2.477 4.06-4.831 5.689-6.46A9.002 9.002 0 0 0 12 1zm0 12.079a3.079 3.079 0 1 1 0-6.158 3.079 3.079 0 0 1 0 6.158z"
            fill="#F43"></path>
        </svg>
        <span class="btn-text-full">Открыть в Яндекс Картах</span>
        <span class="btn-text-short">Открыть в Картах</span>
      </a>
    </div>
    <MapToggleButton />
  </div>
</section>

<script
  is:inline
  async
  src="https://api-maps.yandex.ru/v3/?apikey=d03e0055-6f9f-4639-8d4d-a43b12acccc3&lang=ru_RU"
></script>

<script>
  import type { YMapLocationRequest } from "@yandex/ymaps3-types";
  import "@yandex/ymaps3-default-ui-theme/dist/esm/index.css";

  declare global {
    interface Window {
      ymaps3: typeof ymaps3;
    }
  }

  const loadYmaps3 = (): Promise<void> => {
    return new Promise((resolve) => {
      const checkYmapsLoaded = () => {
        if (window.ymaps3) {
          ymaps3.ready.then(resolve);
        } else {
          setTimeout(checkYmapsLoaded, 50);
        }
      };
      checkYmapsLoaded();
    });
  };

  await loadYmaps3();

  const {
    YMap,
    YMapDefaultSchemeLayer,
    YMapControls,
    YMapDefaultFeaturesLayer,
  } = ymaps3;
  const { YMapZoomControl, YMapDefaultMarker } = await import(
    "@yandex/ymaps3-default-ui-theme"
  );

  const mapContainer = document.querySelector<HTMLElement>(
    ".location-section .map-container",
  );
  const mapElement = document.querySelector<HTMLElement>(
    ".location-section .map",
  );
  const toggleBtn = document.querySelector<HTMLButtonElement>(
    ".location-section .map-toggle-btn",
  );
  const mapHint = document.querySelector<HTMLElement>(
    ".location-section .map-hint",
  );

  if (!mapContainer || !mapElement || !toggleBtn || !mapHint) {
    throw new Error("Not all of the map elements are present");
  }

  const toggleButtonAnimations =
    toggleBtn.querySelectorAll<SVGAnimateElement>(".colored-animation");

  if (!toggleButtonAnimations) {
    throw new Error("Toggle button animation elements is not found");
  }

  const MAP_CENTER: YMapLocationRequest = {
    center: [37.584, 55.7542],
    zoom: 14,
  };

  const isTouchDevice =
    "ontouchstart" in window || navigator.maxTouchPoints > 0;

  // hide button on desktop
  if (!isTouchDevice) {
    toggleBtn.style.display = "none";
  }

  const map = new YMap(
    mapElement,
    {
      location: MAP_CENTER,
      copyrightsPosition: "bottom right",
      behaviors: isTouchDevice ? [] : ["drag"],
    },
    [new YMapDefaultSchemeLayer({}), new YMapDefaultFeaturesLayer({})],
  );

  const controls = new YMapControls({ position: "right" });
  controls.addChild(new YMapZoomControl({ easing: "ease-in-out" }));
  map.addChild(controls);

  const salonMarker = new YMapDefaultMarker({
    coordinates: [37.579055, 55.753136],
    iconName: "hairdressers",
    title: "ОДНО КРЕСЛО",
    subtitle: "Новый Арбат, 34с1",
    color: "silver",
    size: "normal",
    onClick: () => {
      window.open(
        "https://yandex.ru/maps/-/CLbwQ87U",
        "_blank",
        "noopener,noreferrer",
      );
    },
  });

  map.addChild(salonMarker);

  // toggle logic for mobile
  if (isTouchDevice) {
    let isMapActive = false;
    let hintTimeout: number | null = null;

    // initially, map doesn't intercept touches
    mapElement.style.pointerEvents = "none";

    const showHint = () => {
      mapHint.classList.add("visible");
      mapElement.classList.add("blurred");

      toggleButtonAnimations.forEach((animation) => animation.beginElement());

      if (hintTimeout) {
        clearTimeout(hintTimeout);
      }
      hintTimeout = window.setTimeout(() => {
        mapHint.classList.remove("visible");
        mapElement.classList.remove("blurred");
        toggleButtonAnimations.forEach((animation) => animation.endElement());
      }, 2000);
    };

    const hideHint = () => {
      mapHint.classList.remove("visible");
      mapElement.classList.remove("blurred");
      toggleButtonAnimations.forEach((animation) => animation.endElement());
      if (hintTimeout) {
        clearTimeout(hintTimeout);
        hintTimeout = null;
      }
    };

    mapContainer.addEventListener("touchstart", (event) => {
      if (!isMapActive) {
        const target = event.target as HTMLElement;
        if (!target.closest("button")) {
          showHint();
        }
      }
    });

    const toggleMapInteraction = () => {
      isMapActive = !isMapActive;
      hideHint();

      if (isMapActive) {
        // enable map interaction, disable page scroll
        map.setBehaviors(["drag", "pinchZoom"]);
        mapElement.style.pointerEvents = "auto";
        mapElement.style.touchAction = "none";
        mapElement.classList.remove("grayscale");
        toggleBtn.classList.add("enabled");
      } else {
        // disable map interaction, enable page scroll
        map.setBehaviors([]);
        mapElement.style.pointerEvents = "none";
        mapElement.style.touchAction = "auto";
        mapElement.classList.add("grayscale");
        toggleBtn.classList.remove("enabled");
      }
    };

    toggleBtn.addEventListener("click", toggleMapInteraction);
  }
</script>

<style>
  .location-section {
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    row-gap: 1rem;
    padding-top: 1rem;
  }

  .address {
    line-height: 2;
    text-align: center;
  }

  .map-container {
    width: 100%;
    height: 320px;
    padding: 0;
    position: relative;
    touch-action: manipulation;

    & .map {
      --map-blur: ;
      --map-desaturate: ;

      width: 100%;
      height: 100%;
      border: solid 1px rgba(0, 0, 0, 0.3);
      cursor: grab;
      filter: var(--map-blur) var(--map-desaturate);
      transition: filter 0.3s ease;

      &:active {
        cursor: grabbing;
      }

      &.blurred {
        --map-blur: blur(1.5px) brightness(0.95);
      }

      &.grayscale {
        --map-desaturate: grayscale(100%);
      }
    }
  }

  .yandex-open-maps-btn {
    position: absolute;
    bottom: 0.8rem;
    left: 0.8rem;
    z-index: 10;
    text-transform: none;
    display: inline-flex;
    align-items: center;

    height: 31px;
    padding: 8px;
    background: #fffefe;
    border-radius: 8px;
    box-shadow: 0 2px 6px 0 #0003;

    font-size: 0.75rem;
    color: #3c3c3c;
    text-decoration: none;
    white-space: nowrap;

    transition: all 0.15s ease;
    cursor: pointer;
    -webkit-tap-highlight-color: transparent;

    &::before {
      background-image: url("data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyNCIgaGVpZ2h0PSIyNCIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSJub25lIj48cGF0aCBkPSJNMTIgMWE5LjAwMiA5LjAwMiAwIDAgMC02LjM2NiAxNS4zNjJjMS42MyAxLjYzIDUuNDY2IDMuOTg4IDUuNjkzIDYuNDY1LjAzNC4zNy4zMDMuNjczLjY3My42NzMuMzcgMCAuNjQtLjMwMy42NzMtLjY3My4yMjctMi40NzcgNC4wNi00LjgzMSA1LjY4OS02LjQ2QTkuMDAyIDkuMDAyIDAgMCAwIDEyIDF6bTAgMTIuMDc5YTMuMDc5IDMuMDc5IDAgMSAxIDAtNi4xNTggMy4wNzkgMy4wNzkgMCAwIDEgMCA2LjE1OHoiIGZpbGw9IiNGNDMiLz48L3N2Zz4=");

      background-size: 14px 14px;
      content: "";
      display: inline-block;
      height: 14px;
      margin-right: 6px;
      width: 14px;
    }

    & .btn-icon-mobile {
      display: none;
    }

    & .btn-text-short {
      display: none;
    }

    &:hover {
      color: black;
      background-color: white;
      box-shadow: 0 2px 6px 0 rgba(0, 0, 0, 0.3);
    }

    @media (max-width: 768px) {
      & .btn-text-full {
        display: none;
      }

      & .btn-text-short {
        display: inline;
      }
    }

    @media (max-width: 460px) {
      width: 32px;
      height: 32px;
      padding: 0;
      justify-content: center;

      &::before {
        display: none;
      }

      & .btn-icon-mobile {
        display: block;
        width: 24px;
        height: 24px;
      }

      & .btn-text-short {
        display: none;
      }
    }
  }
</style>
